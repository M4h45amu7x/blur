name: Build

on: [push]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest] #, macos-latest, windows-latest]
        build-type: [release]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev \
            libxcursor-dev \
            libxinerama-dev \
            libxi-dev \
            libxrandr-dev \
            libgl1-mesa-dev \
            libncurses5

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v2
        with:
          env: true
          version: "18"

      - name: debug
        run: /home/runner/work/blur/blur/llvm/bin/clang++ --version

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@master
        with:
          version: 1.12.1

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "cd124b84feb0c02a24a2d90981e8358fdee0e077"

      - name: Select CMake Preset
        id: select-preset
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            case "${{ matrix.build-type }}" in
              debug) echo "preset=win-debug" ;;
              release) echo "preset=win-release" ;;
              relwithdebinfo) echo "preset=win-relwithdebinfo" ;;
            esac
          else
            case "${{ matrix.build-type }}" in
              debug) echo "preset=unix-debug" ;;
              release) echo "preset=unix-release" ;;
              relwithdebinfo) echo "preset=unix-relwithdebinfo" ;;
            esac
          fi | tee -a $GITHUB_OUTPUT

      - name: Configure CMake
        run: cmake --preset ${{ steps.select-preset.outputs.preset }}
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg

      - name: Build
        run: cmake --build . --preset ${{ steps.select-preset.outputs.preset }}
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
